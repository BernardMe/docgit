

# NoSQL四大种类


|临时性键值存储	|	永久性键值存储	|	面向文档存储	|	面向列的存储|
| ------ | ------ | ------ | ------ |
|Memcached		|	Redis			|	MongoDB			|	Hbase		|
|Redis			|					|					|				|



# 为什么要用MongoDb

MongoDB是一款面向文档的NoSQL数据库

## 优势
MongoDB提出的是文档，集合的概念，使用BSON(类JSON)作为其数据模型结构，其结构是面向对象的而不是二维表，存储一个用户在MongoDB中是这样子的
{
	username: '123',
	password: '123'
}
使用这样的模型，使得MongoDB能在生产环境中提供高读写的能力，其吞吐量较于mysql等sql数据库大大增强

易伸缩，自动故障转移。
易伸缩指的是提供了分片功能，能对数据集进行分片，数据存储的压力分摊到多台机器上

数据模型因为是面向对象的，所以可以表示丰富的、有层级的数据结构，
比如博客系统中能把'评论'直接放入'文章'对象中，不用像mysql那样创建3张表表示这种关系

数据复制方面,非常方便的扩展数据
支持Master-Slaver（主从）和Replica-Set（副本集）等两种方式


# 适用业务场景

场景一：
要求TPS（每秒事务处理量TransactionPerSecond）特别高的，比如我们项目有一个点赞的功能，这个点赞的功能促发频率特别高，而且并发量也会特别大，但是它的数据量不会特别大。基于这种情况下，我们采用redis来实现点赞功能。

场景二：
项目中涉及评论的内容，而且这个评论表的数据后期会非常大（海量的数据），最后在数据量非常大的情况下还要求比较复杂的查询。基于上述这些情况，我们采用mongodb作为评论表存储数据库。

下面我们接着深入上面的第二个场景，例如下面的这个场景：

场景二：
我们接着评论表的内容，刚开始评论表可能数据不是特别大，可是随着时间的增长，评论表的数据会越来越大，但是我们查询的时间要控制住一段时间内，不能搜索的太慢。
基于这种场景，我们可以采用mongodb中的分片来实现，我们可以将海量的数据查询分别负载到不同的分片服务器上面，最后将数据查询的结果整合到一起。
基于这种情况，不管数据量有多大，我们都可以实现快速的查询功能，查询时间约等于（数据量/分片数量）。
分片其实本身就是一种高可用性方案，因为每一个分片都保存着一份完整的数据，每次插入数据的时候，先插入一个主分片中，然后同步复制到所有从分片中，即使一个分片挂了，其余分片也能自动升级为主分片，继续工作。

注意点：
有人要问，既然每片的数据都一样，那查询的时间不肯定也一样吗，怎么可能是（数据量/分片数量），
关于这个疑问的话，可以研究一下mongodb分片的规则了，mongodb分片的同时也会把数据进行分片划分，同样一份数据但是每片查询的区域是不一样的，比如分片一会查询数据的前半截，然后分片二会查询数据的后半截。这样不就可以做到同样的一份数据，但是每一份查询的数据区域都是不一样的。(这里只是大概思想介绍)


# MongoDB
	
什么是文档:多个键及其关联的值有序的放置在一起便是文档
1.文档是MongoDB的基本单元,核心概念  类似于关系型数据库的行
2.每一个文档都有一个特殊的键"_id",它在文档所在的集合中是唯一的
3.MongoDB不但区分类型还区分大小写 文档不能有重复的键
MongoDB文档类似与JSON对象，字段值可以包含其他文档，数组及文档数组
  
## 集合
集合就是一组文档(相当于关系型数据库里的表)
	
### 集合是灵活模式(!=无模式)的
一个集合里的文档可以是各式各样的
如下
{"key1":"Hello word"}
{"key2":5}
上面两个文档的数据类型不同.键也不一样,因为集合里可以放置任意类型的文档

### 集合的命名
不能是""空串
不能含有\0字符,这个字符表示集合名的结尾
集合不能以system.开头 这是为系统集合保留的前缀
用户创建的集合的名字不能包含保留字$

### 子集合
组织集合的一种惯例是使用"."字符分开的按命名空间的划分的子集合.
如
person.detail与person.address  这样的目的只是使组织结构更好些 也就是说 person这个集合(这里根本不需要存在)及其子集合根本没有任何关系
GridFS是一种存储大文本的协议,使用子集合来存储文件的元数据  这样就与内容快分开了

### MongoDB的客户端shell
db是MongoDB的全局变量 db 保存的是客户端与服务器数据库的连接 这个变量是通过shell访问MongoDB的主要入口点

### ObjectID组成

`_id` 是mongodb ObjectID类型的，它由12位结构组成，包括timestamp, machined, processid, counter 等。

TimeStamp

前 4字节是一个unix的时间戳，是一个int类别，我们将上面的例子中的objectid的前4位进行提取“4df2dcec”，然后再将他们安装十六进制 转为十进制：“1307761900”，这个数字就是一个时间戳，为了让效果更佳明显，我们将这个时间戳转换成我们习惯的时间格式
`$ date -d ‘1970-01-01 UTC 1307761900  sec’  -u`
2011年 06月 11日 星期六 03:11:40 UTC
前 4个字节其实隐藏了文档创建的时间，并且时间戳处在于字符的最前面，这就意味着ObjectId大致会按照插入进行排序，这对于某些方面起到很大作用，如 作为索引提高搜索效率等等。使用时间戳还有一个好处是，某些客户端驱动可以通过ObjectId解析出该记录是何时插入的，这也解答了我们平时快速连续创 建多个Objectid时，会发现前几位数字很少发现变化的现实，因为使用的是当前时间，很多用户担心要对服务器进行时间同步，其实这个时间戳的真实值并 不重要，只要其总不停增加就好。
比如`"_id" : ObjectId("5b1886f8965c44c78540a4fc")`
取id的前4个字节。由于id是16进制的string，4个字节就是32位，对应id前8个字符。即5b1886f8, 转换成10进制为1528334072. 加上1970，就是当前时间。

Machine

接下来的三个字节，就是 2cdcd2 ,这三个字节是所在主机的唯一标识符，一般是机器主机名的散列值，这样就确保了不同主机生成不同的机器hash值，确保在分布式中不造成冲突，这也就是在同一台机器生成的objectid中间的字符串都是一模一样的原因。

pid

上面的Machine是为了确保在不同机器产生的objectid不冲突，而pid就是为了在同一台机器不同的mongodb进程产生了objectid不冲突，接下来的0936两字节就是产生objectid的进程标识符。

increment

前面的九个字节是保证了一秒内不同机器不同进程生成objectid不冲突，这后面的三个字节a8b817，是一个自动增加的计数器，用来确保在同一秒内产生的objectid也不会发现冲突，允许256的3次方等于16777216条记录的唯一性。

##  Mongodb数据库中的各种角色

### 数据库访问
		角色名称	拥有权限
		read		允许读取指定数据库的角色
		readWrite	允许读写指定数据库的角色

### 数据库管理
		角色名称	拥有权限
		dbAdmin		允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile
		userAdmin	允许管理当前数据库的用户，如创建用户、为用户授权
		dbOwner		数据库拥有者(最高)，集合了dbAdmin/userAdmin/readWrite角色权限

		
## mongodb存储二进制数据的二种方式

### binary bson

BJSON格式本身就支持保存二进制格式的数据，因此可以把文件的二进制格式的数据直接保存到MongoDB的文档结构中

当文件大小较小的时候，直接存入文档对象实现起来更简洁。比如大量图片文件的存取等，一般图片文件都不会超过4M

### gridfs

为了提供对大容量文件存取的支持
支持java语言操作



# MongoDB使用

## MongoDB的安装及配置 

之前整理的mongo基本语法都是在没有用户名密码验证的条件下测试的，因为mongo与mysql不同，它安装的时候默认是没有权限控制的额，也就是说任何人，只要知道了host和port都可以登陆数据库并操作。
如果想要设置用户，需要自己另行配置。

### Windows版本

（1）登录Mongodb官网下载并将zip文件解压放到（d:\mongodb），确定MongoDB主目录`D:\mongodb`
（2）创建数据库文件的存放位置，比如d:/mongodb/data/db。启动mongodb服务之前需要必须创建数据库文件的存放文件夹，否则命令不会自动创建，而且不能启动成功。
（3）打开cmd命令行，进入D:\mongodb\bin目录（如图先输入d:进入d盘然后输入cd d:\mongodb\bin），

输入如下的命令启动mongodb服务：

`D:/mongodb/bin>mongod --dbpath D:\mongodb\data\db`
（4）mongodb默认连接端口27017，如果出现如图的情况，可以打开http://localhost:27017查看
（5）其实可以将MongoDB设置成Windows服务，这个操作就是为了方便，每次开机MongoDB就自动启动了。

在d:\mongodb下新建文件夹log（存放日志文件）并且新建文件mongodb.log
在d:\mongodb新建文件mongo.config

在mongo.config中输入：
```shell
dbpath=D:\mongodb\data\db
logpath=D:\mongodb\log\mongo.log  
```
（6）用管理员身份打开cmd命令行，进入D:\mongodb\bin目录，输入如下的命令：

`D:\mongodb\bin>mongod --config D:\mongodb\mongo.config `
如图结果存放在日志文件中，查看日志发现已经成功。如果失败有可能没有使用管理员身份，遭到拒绝访问。

（7）打开cmd输入services.msc查看服务可以看到MongoDB服务，点击可以启动
若以上没有添加mongo服务，则命令行添加：

cd D:\mongodb\bin
`mongod --config D:\mongodb\mongo.config --journal --install`

启动服务即可：
到服务中启mongodB（或者cmd命令提示符下输入：`net start mongodb` 即可启动mongodb了）



## Java操作Mongo(Java操作GridFS)

GridFS 用于存储和恢复那些超过16M（BSON文件限制）的文件(如：图片、音频、视频等)。

GridFS 也是文件存储的一种方式，但是它是存储在MonoDB的集合中。

GridFS 可以更好的存储大于16M的文件。

GridFS 会将大文件对象分割成多个小的`chunk(文件片段)`,一般为256k/个,每个chunk将作为MongoDB的一个文档(document)被存储在`chunks集合`中。

GridFS 用两个集合来存储一个文件：fs.files与fs.chunks。

每个文件的实际内容被存在chunks(二进制数据)中,和文件有关的`meta数据(filename,content_type,还有用户自定义的属性)`将会被存在`files集合`中。
	

	
	
	
	
	