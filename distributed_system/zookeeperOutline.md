

## Zookeeper

总纲

************************************

 为什么想使用Zookeeper?

 Zookeeper是什么?

 如何使用Zookeeper?



************************************


### 为什么

当设计一个分布式系统时，一般需要设计和开发一些协调服务:

 + 名称服务

 + 锁定

 + 同步

 + 配置管理

 + 领导者选举
等等，

虽然可以从头开始设计和实现所有这些服务，但没有必要，就好象你不会在代码中随处编写自己的随机数发生器一样。这里有一个要求：人们不应该在每次有需要时就到处从头编写自己的名称服务或者领导者选举服务。此外，你可以相对容易地完成一个非常简单的组成员服务，但是，要编写他们来提供可靠性，可扩展性，可能需要更多的工作。

此时，Zookeeper开源了，它是一个针对分布式系统的，开箱即用的，可靠的，可扩展的，高性能的协调服务。

ZooKeeper 虽然是一个针对分布式系统的协调服务，但它本身也是一个分布式应用程序。Zookeeper遵循一个简单地客户端-服务器模型，其中客户端是使用服务的节点(即机器)，而服务器是提供服务的节点。Zookeeper服务器集合形成了一个Zookeeper集合体(ensemble)。在任何给定的时间内，一个Zookeeper客户端可以连接到一个Zookeeper服务器。每个Zookeeper服务器都可以同时处理大量客户端连接。


Zookeeper有一个类似与文件系统的数据模型，由znodes组成。可以将znodes(Zookeeper数据节点)视为类似Unix系统的传统系统中的文件，但他们可以有子节点。另一种方式是将它们视为目录，它们可以有与其相关的数据。每个这些目录都被称为一个znode。


当客户端请求读取特定znode的内容时，都去操作实在客户端所连接的服务器上进行的，因此，由于只涉及集合体中的一个服务器，所以读取是快速和可扩展的。
然而，为了成功完成写入操作，要求zookeeper集合体的严格意义上的多数节点都是可用的。在启动Zookeeper服务时，集合体中的某个节点被选举为领导者。当客户端发出一个写入请求时，所连接的服务器会将请求传递给领导者。此领导者对对集合体的所有节点发出形同的写入请求。如果严格意义上的多数节点(也被称为法定的数据)成功响应改写入请求，那么写入请求被视为已成功完成。然后，一个成功的返回代码会返回给发起写入请求的客户端。如果集合体中的可用节点数量未达到法定数量，那么zookeeper 服务将不起作用。

法定数量是通过严格意义上的多数节点来表示的。在结合体重，可以包含一个节点，但他个不是一个高可用和可靠的系统。如果在集合体中有两个节点，那么这两个节点都必须已经启动并让服务正常运行，因为两个节点中的一个并不是严格意义上的多数。如果在集合体中有三个节点，即使其中一个停机了，你仍然可以获得正常运行的服务(三个中的两个是严格意义上的多数)。出于这个原因，zookeeper的集合体中通常包含奇数数量的的节点，因为就荣错而言，与三个节点相比，四个节点不占优势，因为只要有两个节点停机，zookeeper服务就会停止。在有五个节点的集群上，需要是三个节点停机才会导致zookeeper服务停止运。


-------------------------------------------------------------

思考：让我们再来思考一下 ZooKeeper 集合体中需要有多少个节点?

读取操作始终从连接到客户端的 ZooKeeper 服务器读取数据，所以它们的性能不会随着集合体中的服务器数量额变化而变化。但是，仅在写入法定数量的节点时，写入操作才是成功的。这意味着，随着在集合体中的节点数量的增加，写入性能会下降，因为必须将写入内容写入到更多的服务器中，并在更多服务器之间进行协调。

回答：
ZooKeeper 的美妙之处在于，想运行多少服务器完全由您自己决定。
如果想运行一台服务器，从 ZooKeeper 的角度来看是没问题的；只是您的系统不再是高度可靠或高度可用的。
三个节点的Zookeeper结合体支持在一个节点故障的情况下不丢失服务，这对于大多数用户来说，可能是没问题的，也是最常见的部署拓扑。
不过为了安全，可以在你的系统中使用五个节点。五个节点的集合体让你可以拿出一台服务器进行维护和滚动升级，并能够在不中断服务的情况下承受第二台服务器的意外故障。

-------------------------------------------------------------


因此，在 ZooKeeper 集合体中，三、五或七是最典型的节点数量。请记住，ZooKeeper 集合体的大小与分布式系统中的节点大小没有什么关系。分布式系统中的节点将是Zookeeper集合体的客户端，每个Zookeeper服务器都能够以可扩展的方式处理大量客户端。


### 如何用

查看解析后的二进制日志文件

首先将工具拷贝到/data
`cp lib/slf4j-api-1.7.25.jar /data`
`cp zookeeper.jar /data `

然后将你要解析的二进制log文件也复制到 /data

`java -classpath .\slf4j-api-1.7.25.jar;.\zookeeper-3.4.12.jar org.apache.zookeeper.server.LogFormatter log.1 > log.txt`

将解析后的数据写入日志文件 log.txt中




