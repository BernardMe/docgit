

# 预备知识

## 概念

### 缓存能解决的问题
性能 
==> 将相应数据村吃起来以避免数据的重复创建，处理和传输，可有效提高性能。
比如将不改变的数据缓存起来，例如国家列表等，这样能明显提高web程序的反应速度；
稳定性 
==> 同一个应用中，对同一数据，逻辑功能和用户界面的多次请求时经常发生的。当用户基数很大时，如果每次请求都进行处理，消耗的资源是很大的浪费，也同时造成系统的不稳定。例如，web应用中，对一些静态页面的呈现内容进行缓存能有效的节省资源，提高稳定性。而缓存数据也能降低对数据库的访问次数，降低数据库的负担和提高数据库的服务能力；
可用性 
==> 有时，提供数据信息的服务可能会意外停止，如果使用了缓存技术，可以在一定时间内扔正常提供对最终用户的支持，提高了系统的可用性。

### 缓存特征

#### 命中率
命中率=返回正确结果数/请求缓存次数，命中率问题是缓存中的一个非常重要的问题，它是衡量缓存有效性的重要指标。命中率越高，表明缓存的使用率越高。
 
#### 最大元素(或最大空间)
缓存中可以存放的最大元素的数量，一旦缓存中元素数量超过这个值（或者缓存数据所占空间超过其最大支持空间），那么将会触发缓存启动清空策略根据不同的场景合理的设置最大元素值往往可以一定程度上提高缓存的命中率，从而更有效的时候缓存。

#### 清空策略
如上描述，缓存的存储空间有限制，当缓存空间被用满时，如何保证在稳定服务的同时有效提升命中率？这就由缓存清空策略来处理，设计适合自身数据特征的清空策略能有效提升命中率。常见的一般策略有：
FIFO(first in first out)
LFU(less frequently used)
LRU(least recently used)

### 缓存分类和应用场景
在目前的应用服务框架中，比较常见的，时根据缓存与应用的藕合度，分为local cache（本地缓存）和remote cache（分布式缓存）：


### 什么是进程内缓存
顾名思义，进程内缓存是与应用程序在相同地址空间的缓存。
Google Guava是一个提供了简单进程内缓存API的很好的例子。
另一方面，分布式缓存是应用程序的外部扩展，通常部署在多个节点上，共同构成一个大的逻辑缓存。
Memcached是一个流行的分布式缓存。Ehcache则是一个通过配置可以以任一种方式使用的缓存产品。


### 一致性
进程内缓存
当使用进程内缓存时，缓存元素是特定应用程序实例本地的。然而，许多中到大型应用通常会做负载均衡，从而不存在一个作为整体的独立应用。在这种情况下，很可能会构建出一个有多少应用实例就有多少缓存的解决方案，每个缓存都有各自的状态，这就导致了不一致性。随着缓存元素的过期或被逐出，所有缓存实例间可能达到最终一致性。

分布式缓存
分布式缓存，虽然部署在由多个节点构成的集群上，会提供一个单一缓存的逻辑视图（以及状态）。多数情况下，分布式缓存中的对象将会存在于集群中的单个节点。通过哈希算法，缓存引擎总是可以判断出某个键值对位于哪个特定节点。由于整个集群总是会有一个特定状态，所以从来不会存在不一致的情况。


### 开销
进程内缓存
揭开进程内缓存的奥秘 一文中提到进程内缓存可能会影响垃圾回收进而影响系统性能。而这将会由缓存大小以及对象逐出和过期的频率决定。

分布式缓存
分布式缓存有两大主要开销会导致其慢于进程内缓存(但优于无缓存方案)：
网络延时
对象序列化

备注
正如之前所提到的，如果你试图寻求一个多节点部署情况下的强一致性缓存解决方案，采用分布式缓存。


### 可靠性
进程内缓存
进程内缓存使用与应用程序相同的堆空间，因此必须非常小心地决定缓存所能使用的内存大小上限。如果应用程序用光了内存，想要试图恢复并不容易。

分布式缓存
分布式缓存作为多个节点的独立进程运行，因此单点故障并不会导致缓存失效。丢失的缓存元素将会在下一次缓存未命中时进入存活的节点。分布式缓存情况下，缓存整体失效的最坏后果是降低系统性能，而不是导致系统整体故障。

备注
进程内缓存适用于较小且频率可预见的访问场景，尤其适用于不变对象。
对于较大且不可预见的规模的访问，最好采用分布式缓存。


## J2Cache缓存框架

### 两级缓存结构
L1： 进程内缓存(caffeine\ehcache) 
L2： 集中式缓存，支持多种集中式缓存服务器，如 Redis
由于大量的缓存读取会导致 L2 的网络带宽成为整个系统的瓶颈，因此 L1 的目标是降低对 L2 的读取次数
L1过期时不通知L2删除，L2手动删除时，通知其他L1进行删除操作。


### J2Cache 配置

配置文件位于 core/resources 目录下，包含三个文件：

j2cache.properties J2Cache 核心配置文件，可配置两级的缓存，Redis 服务器、连接池以及缓存广播的方式

caffeine.properties 如果一级缓存选用 Caffeine ，那么该文件用来配置缓存信息

